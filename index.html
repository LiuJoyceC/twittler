<!DOCTYPE html>
<html>
  <head>
    <title>myTwittler</title>
    <link rel="stylesheet" href="myTwittler.css">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <script>

      $(document).ready(function(){
        var $body = $('body');
        //$body.html('');   <!-- Commented out so header is not erased -->

        var createTweetLine = function(tweet) {
          var $tweet = $('<div class="tweet"></div>');
          var $atUsername = $('<span class="at-username"></span>');
          var $timestamp = $('<span class="timestamp"></span>');
          var $hashtag = $('<span class="hashtag"></span>');
          var messageTagged = tweet.message.split('#'); // Assume you can only have up to one hashtag per tweet
          if (messageTagged.length == 1) {
            var tag = '';
            $hashtag.text('');
          } else {
            var tag = messageTagged[1];
            $hashtag.text('#' + tag);
          }

          $atUsername.text('@' + tweet.user);
          $atUsername.attr('data-username', tweet.user);
          $hashtag.attr('data-hashtag', tag);
          $timestamp.text(tweet.created_at);
          $tweet.text(/*'@' + tweet.user + */': ' + messageTagged[0] + " ");
          $tweet.prepend($atUsername);
          $tweet.append($hashtag);
          $tweet.append($timestamp);
          return $tweet;
        };

        var prevLength = streams.home.length;
        var index = prevLength - 1;
        while(index >= 0){
          var tweet = streams.home[index];
/*          var $tweet = $('<div></div>');
          $tweet.text('@' + tweet.user + ': ' + tweet.message);  <-- Moved to createTweetLine above */
          var $tweet = createTweetLine(tweet);
          $tweet.appendTo($body);
          index -= 1;
        }

        var unhideTweets = function() {
          $('.tweet').filter('.hidden').removeClass('hidden');
        }

        $('button').click(function() {
          unhideTweets();
          var newLength = streams.home.length;
          if (newLength > prevLength) {
            for (index = prevLength; index < newLength; index++) {
              var tweet = streams.home[index];
              var $tweet = createTweetLine(tweet);
              $tweet.insertAfter($('.tweet-begin'));
            }
            prevLength = newLength;
            clickWrapper(); //Without recalling this function, the new tweets cannot have their usernames clicked on.
          }
        })

        var clickWrapper = function() { // The clickHandler is wrapped in another function so it can be recalled when new tweets are added, because the new tweets have not been 'activated' by the first call of the clickHandler

          $('.at-username').click(function() {
            unhideTweets();
            var selectedUser = $(this).data('username');
            $('.at-username').filter(function() {return $(this).data('username') !== selectedUser;}).closest('.tweet').addClass('hidden');
          })

          $('.hashtag').click(function() {
            unhideTweets();
            var selectedTag = $(this).data('hashtag');
            $('.hashtag').filter(function() {return $(this).data('hashtag') !== selectedTag;}).closest('.tweet').addClass('hidden');
          })
        };
        clickWrapper();

        var visitor = '';

        $('.login-btn').click(function() {
          visitor = $('.login-field').val();
          
          if (visitor !== '') {
            $('.login-label').text('Welcome, ' + visitor + '!');
            $('.login-field').addClass('hidden');
            $('.login-btn').text('Sign out');
          }
        })

      });

    </script>

    <!-- HTML portion -->

    <!-- Header -->

    <header>
      <h1>myTwittler</h1>
      <fieldset class="login">
        <label>
          <span class="login-label">Username</span>
          <input type="text" name="username" class="login-field">
        </label>
        <span class="login-btn">Sign in</span>
      </fieldset>
    </header>

    <!-- Tweets section -->

    <button>See new Tweets!</button>

    <!-- Beginning divider for tweets: this should be the last item in the body section of the html -->

    <div class="tweet-begin"></div>

  </body>
</html>
